pipeline {
    agent any

    environment {
        IMAGE_NAME = 'rani19/backend'
        TAG = "build-${env.BUILD_NUMBER}"
        DEV_REPO_URL = 'https://github.com/RaniSaed/smart-retail-dev.git'
        CONFIG_REPO_URL = 'https://github.com/RaniSaed/smart-retail-config.git'
        DOCKER_CREDENTIALS_ID = 'docker-hub-creds'
        SLACK_CREDENTIAL_ID = 'slack-webhook'
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '5'))
        timeout(time: 20, unit: 'MINUTES')
    }

    stages {
        stage('üì• Clone Dev Repo') {
            steps {
                dir('dev') {
                    git url: "${DEV_REPO_URL}", branch: 'main'
                }
            }
        }

        stage('üìÅ Clone Config Repo') {
            steps {
                dir('config') {
                    git url: "${CONFIG_REPO_URL}", branch: 'main'
                }
            }
        }

        stage('üïµÔ∏è Check Backend Changes') {
            steps {
                dir('dev') {
                    script {
                        def backendChanged = sh(
                            script: "git diff --name-only HEAD~1 HEAD | grep -q '^backend/'",
                            returnStatus: true
                        ) == 0

                        if (!backendChanged) {
                            echo "‚ö†Ô∏è No changes in backend code. Aborting..."
                            currentBuild.result = 'ABORTED'
                            error("No changes in backend/")
                        }
                    }
                }
            }
        }

        stage('üê≥ Build Docker Image') {
            steps {
                dir('dev') {
                    script {
                        echo "üì¶ Building image ${IMAGE_NAME}:${TAG}"
                        docker.build("${IMAGE_NAME}:${TAG}", "-f backend/Dockerfile backend")
                    }
                }
            }
        }

        stage('üöÄ Push to Docker Hub') {
            steps {
                withCredentials([usernamePassword(credentialsId: "${DOCKER_CREDENTIALS_ID}", usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                    script {
                        docker.withRegistry("https://index.docker.io/v1/", "${DOCKER_CREDENTIALS_ID}") {
                            docker.image("${IMAGE_NAME}:${TAG}").push()
                            docker.image("${IMAGE_NAME}:${TAG}").push("latest")
                        }
                    }
                }
            }
        }

        stage('‚úèÔ∏è Update Deployment YAML') {
            steps {
                dir('config') {
                    script {
                        def filePath = "k8s/backend/deployment.yaml"
                        def newImage = "${IMAGE_NAME}:${TAG}"
                        echo "üîß Updating ${filePath} with new image: ${newImage}"
                        sh "sed -i 's|image:.*|image: ${newImage}|' ${filePath}"
                        sh "cat ${filePath}"
                    }
                }
            }
        }

        stage('üì§ Commit & Push Changes') {
            steps {
                dir('config') {
                    withCredentials([string(credentialsId: 'github-push-token', variable: 'GIT_TOKEN')]) {
                        script {
                            sh """
                                git config user.email "rani.saed19@gmail.com"
                                git config user.name "Rani Saed (CI/CD)"
                                git add k8s/backend/deployment.yaml
                                if ! git diff --cached --quiet; then
                                    git commit -m "üöÄ Update backend image to ${TAG}"
                                    git remote set-url origin https://${GIT_TOKEN}@github.com/RaniSaed/smart-retail-config.git
                                    git push origin main
                                else
                                    echo "No changes to commit"
                                fi
                            """
                        }
                    }
                }
            }
        }

        stage('‚ù§Ô∏è Health Check') {
            steps {
                script {
                    echo "üîç Checking backend health..."
                    def maxAttempts = 15
                    def waitTime = 10
                    def healthy = false

                    for (int i = 1; i <= maxAttempts; i++) {
                        echo "Attempt ${i}/${maxAttempts}: Curling http://gogo-backend:5000/health..."
                        def healthCheckStatus = sh(
                            script: "curl -s http://gogo-backend:5000/health | grep -q '\"status\":\"healthy\"'",
                            returnStatus: true
                        )
                        if (healthCheckStatus == 0) {
                            echo "‚úÖ Backend is healthy on attempt ${i}!"
                            healthy = true
                            break
                        } else {
                            echo "‚ùå Backend not yet healthy."
                            if (i < maxAttempts) {
                                sleep waitTime
                            }
                        }
                    }

                    if (!healthy) {
                        error "‚ùå Backend health check failed after ${maxAttempts} attempts!"
                    }
                }
            }
        }

        stage('üõ°Ô∏è DR Failover & Sync') {
            steps {
                script {
                    // Initialize variables for DR report
                    env.DR_FRONTEND_STATUS = "UNKNOWN"
                    env.DR_BACKEND_STATUS = "UNKNOWN"
                    env.DR_DATA_SYNC_STATUS = "UNKNOWN"
                    env.DR_TEST_RESULT = "FAILURE" // Assume failure until proven otherwise

                    echo "üîÑ **Restoring data from Kubernetes backend (5000) to Main Backend (5001)**..."
                    // This seed is intended for the main backend. If the main backend is down, this command will likely fail.
                    // The || true allows the pipeline to continue even if the main backend isn't running.
                    def mainBackendSeedSuccess = sh(
                        script: 'docker exec gogo-backend python /app/seed.py || true',
                        script: 'docker exec gogo-dr-backend python /app/seed.py || true',
                        returnStatus: true
                    )
                    if (mainBackendSeedSuccess == 0) {
                        env.DR_DATA_SYNC_STATUS = "Main Backend Seeded"
                    } else {
                        env.DR_DATA_SYNC_STATUS = "Main Backend Seed Failed or Not Running (Expected if main is down)"
                    }


                    echo "üîç Checking if **Main Frontend container (gogo-main-frontend)** is running..."
                    def frontendRunning = sh(
                        script: "docker ps --filter 'name=gogo-main-frontend' --format '{{.Names}}'",
                        returnStdout: true
                    ).trim()

                    if (frontendRunning == 'gogo-main-frontend') {
                        echo "‚úÖ Main Frontend container (gogo-main-frontend) is running. Ensuring DR Frontend is stopped."
                        // If main is up, ensure DR frontend is stopped
                        echo "Stopping DR Frontend (gogo-dr-frontend)..."
                        sh "docker stop gogo-dr-frontend || true" // Stop DR, don't start it if main is active.
                        echo "Main Frontend (3000) is active."
                        env.DR_FRONTEND_STATUS = "Main Active"
                    } else {
                        echo "üö® Main Frontend container (gogo-main-frontend) is **NOT** running. Activating DR Frontend (gogo-dr-frontend) (on 3002)."
                        // If main is down, stop main frontend and start DR frontend
                        echo "Stopping Main Frontend (gogo-main-frontend)..."
                        sh "docker stop gogo-main-frontend || true" // Stop main, in case it's in a bad state
                        echo "Starting DR Frontend (gogo-dr-frontend)..."
                        sh "docker start gogo-dr-frontend" // Start DR frontend. No || true here, we expect it to start.
                        // Add a health check here specifically for gogo-dr-frontend after potential start
                        def drFrontendHealthy = sh(
                            script: "curl -s http://localhost:3002 || true", // Example health check
                            returnStatus: true
                        )
                        if (drFrontendHealthy == 0) {
                            echo "‚úÖ DR Frontend is healthy on 3002!"
                            env.DR_FRONTEND_STATUS = "DR Activated & Healthy (3002)"
                        } else {
                            echo "‚ùå DR Frontend activated but Health Check Failed (3002)"
                            env.DR_FRONTEND_STATUS = "DR Activated but Health Check Failed (3002)"
                            // Consider failing the build here if DR frontend health is critical
                            // error "DR Frontend health check failed after activation!"
                        }
                    }

                    echo "üîç Checking if **Main Backend container (gogo-backend)** is running..."
                    def backendRunning = sh(
                        script: "docker ps --filter 'name=gogo-backend' --format '{{.Names}}'",
                        returnStdout: true
                    ).trim()

                    if (backendRunning == 'gogo-backend') {
                        echo "‚úÖ Main Backend container (gogo-backend) is running. Ensuring DR Backend is stopped."
                        // If main is up, ensure DR backend is stopped
                        echo "Stopping DR Backend (gogo-dr-backend)..."
                        sh "docker stop gogo-dr-backend || true" // Stop DR backend
                        env.DR_BACKEND_STATUS = "Main Active"
                    } else {
                        echo "üö® Main Backend container (gogo-backend) is **NOT** running. Activating DR Backend (gogo-dr-backend) (on 5002) and seeding data."
                        // If main is down, stop main backend and start DR backend
                        echo "Stopping Main Backend (gogo-backend)..."
                        sh "docker stop gogo-backend || true" // Stop main backend
                        echo "Starting DR Backend (gogo-dr-backend)..."
                        sh "docker start gogo-dr-backend" // Start DR backend. No || true, we expect it to start.
                        echo "üå± Running seed.py inside DR Backend container (gogo-dr-backend) to sync data from Kubernetes backend (5000)..."
                        
                        if (drBackendSeedSuccess == 0) {
                            // After seeding, perform a health check on the DR backend
                            def drBackendHealthy = sh(
                                script: "curl -s http://localhost:5002/health | grep -q '\"status\":\"healthy\"'",
                                returnStatus: true
                            )
                            if (drBackendHealthy == 0) {
                                echo "‚úÖ DR Backend is healthy on 5002!"
                                env.DR_BACKEND_STATUS = "DR Activated & Healthy (5002)"
                                env.DR_DATA_SYNC_STATUS = "DR Backend Seeded Successfully"
                            } else {
                                echo "‚ùå DR Backend activated but Health Check Failed (5002)"
                                env.DR_BACKEND_STATUS = "DR Activated but Health Check Failed (5002)"
                                env.DR_DATA_SYNC_STATUS = "DR Backend Seeded but Health Check Failed"
                                // Consider failing the build here if DR backend health is critical
                                // error "DR Backend health check failed after activation!"
                            }
                        } else {
                             echo "‚ùå DR Backend activated but Seed Failed (5002)"
                             env.DR_BACKEND_STATUS = "DR Activated but Seed Failed (5002)"
                             env.DR_DATA_SYNC_STATUS = "DR Backend Seed Failed"
                             // Consider failing the build here if DR backend seed fails
                             // error "DR Backend data seeding failed!"
                        }
                    }

                    // Determine overall DR test result based on individual statuses
                    // Refined logic: both active components must be healthy or main must be active
                    if (((env.DR_FRONTEND_STATUS == "Main Active" || env.DR_FRONTEND_STATUS == "DR Activated & Healthy (3002)")) &&
                        ((env.DR_BACKEND_STATUS == "Main Active" || env.DR_BACKEND_STATUS == "DR Activated & Healthy (5002)")) &&
                        (env.DR_DATA_SYNC_STATUS.contains("Seeded"))) {
                        env.DR_TEST_RESULT = "SUCCESS"
                    } else {
                        env.DR_TEST_RESULT = "FAILURE"
                    }
                }
            }
        }

        stage('üìä Generate DR Readiness Reports') {
            steps {
                script {
                    echo "--- DR Readiness Report ---"
                    echo "Build Number: ${env.BUILD_NUMBER}"
                    echo "Build URL: ${env.BUILD_URL}"
                    echo "Timestamp: ${new Date().format('yyyy-MM-dd HH:mm:ss')}"
                    echo "---------------------------"
                    echo "DR Test Result: **${env.DR_TEST_RESULT}**"
                    echo "DR Frontend Status: ${env.DR_FRONTEND_STATUS}"
                    echo "DR Backend Status: ${env.DR_BACKEND_STATUS}"
                    echo "DR Data Sync Status: ${env.DR_DATA_SYNC_STATUS}"
                    echo "---------------------------"

                    // You can save this to a file as a build artifact
                    def reportContent = """
                        DR Readiness Report
                        -------------------
                        Build Number: ${env.BUILD_NUMBER}
                        Build URL: ${env.BUILD_URL}
                        Timestamp: ${new Date().format('yyyy-MM-dd HH:mm:ss')}
                        -------------------
                        DR Test Result: ${env.DR_TEST_RESULT}
                        DR Frontend Status: ${env.DR_FRONTEND_STATUS}
                        DR Backend Status: ${env.DR_BACKEND_STATUS}
                        DR Data Sync Status: ${env.DR_DATA_SYNC_STATUS}
                        -------------------
                    """.stripIndent()

                    writeFile file: 'dr-readiness-report.txt', text: reportContent
                    archiveArtifacts artifacts: 'dr-readiness-report.txt', fingerprint: true

                    // Send a richer Slack notification with the report summary
                    withCredentials([string(credentialsId: "${SLACK_CREDENTIAL_ID}", variable: 'SLACK_WEBHOOK')]) {
                        def slackMessage = ""
                        if (env.DR_TEST_RESULT == "SUCCESS") {
                            slackMessage = "‚úÖ *DR Readiness Test Passed!*\\nBuild: <${env.BUILD_URL}|#${env.BUILD_NUMBER}>\\nFrontend: ${env.DR_FRONTEND_STATUS}\\nBackend: ${env.DR_BACKEND_STATUS}\\nData Sync: ${env.DR_DATA_SYNC_STATUS}"
                        } else {
                            slackMessage = "‚ùå *DR Readiness Test FAILED!*\\nBuild: <${env.BUILD_URL}|#${env.BUILD_NUMBER}>\\nFrontend: ${env.DR_FRONTEND_STATUS}\\nBackend: ${env.DR_BACKEND_STATUS}\\nData Sync: ${env.DR_DATA_SYNC_STATUS}\\nCheck logs for details."
                        }

                        sh """
                            curl -X POST -H 'Content-type: application/json' \
                            --data '{"text": "${slackMessage}"}' $SLACK_WEBHOOK
                        """
                    }
                }
            }
        }
    }

    post {
        success {
            echo "‚úÖ Backend image pushed and deployment updated."
            withCredentials([string(credentialsId: "${SLACK_CREDENTIAL_ID}", variable: 'SLACK_WEBHOOK')]) {
                sh """
                    curl -X POST -H 'Content-type: application/json' \
                    --data '{"text": "‚úÖ *Backend* CI/CD succeeded ‚Äî *${TAG}* deployed & healthy!"}' $SLACK_WEBHOOK
                """
            }
        }

        aborted {
            echo "‚èπÔ∏è Pipeline aborted (no backend changes)"
            withCredentials([string(credentialsId: "${SLACK_CREDENTIAL_ID}", variable: 'SLACK_WEBHOOK')]) {
                sh """
                    curl -X POST -H 'Content-type: application/json' \
                    --data '{"text": "‚ö†Ô∏è *Backend* pipeline aborted ‚Äî no changes detected."}' $SLACK_WEBHOOK
                """
            }
        }

        failure {
            echo "‚ùå Pipeline failed"
            withCredentials([string(credentialsId: "${SLACK_CREDENTIAL_ID}", variable: 'SLACK_WEBHOOK')]) {
                sh """
                    curl -X POST -H 'Content-type: application/json' \
                    --data '{"text": "‚ùå *Backend* pipeline failed. Check Jenkins logs."}' $SLACK_WEBHOOK
                """
            }
        }
    }
}