pipeline {
  agent any

  environment {
    IMAGE_NAME = 'rani19/backend'
    TAG = "build-${env.BUILD_NUMBER}"
    DEV_REPO_URL = 'https://github.com/RaniSaed/smart-retail-dev.git'
    CONFIG_REPO_PATH = 'k8s/backend/deployment.yaml'
    DOCKER_CREDENTIALS_ID = 'docker-hub-creds'
  }

  options {
    buildDiscarder(logRotator(numToKeepStr: '5'))
    timeout(time: 20, unit: 'MINUTES')
  }

  stages {
    stage('üì• Clone Dev Repo') {
      steps {
        dir('dev') {
          git url: "${DEV_REPO_URL}", branch: 'main'
        }
      }
    }

    stage('üîç Check Backend Changes') {
      steps {
        dir('dev') {
          script {
            def backendChanged = sh(
              script: "git diff --name-only HEAD~1 HEAD | grep -q '^backend/'",
              returnStatus: true
            ) == 0

            if (!backendChanged) {
              echo "‚ö†Ô∏è No changes in backend code. Aborting..."
              currentBuild.result = 'ABORTED'
              error("No changes in backend/")
            }
          }
        }
      }
    }

    stage('üê≥ Build Docker Image') {
      steps {
        dir('dev') {
          script {
            echo "üì¶ Building Docker image: ${IMAGE_NAME}:${TAG}"
            docker.build("${IMAGE_NAME}:${TAG}", "-f backend/Dockerfile backend")
          }
        }
      }
    }

    stage('üì§ Push to Docker Hub') {
      steps {
        withCredentials([usernamePassword(credentialsId: "${DOCKER_CREDENTIALS_ID}", usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
          script {
            docker.withRegistry("https://index.docker.io/v1/", "${DOCKER_CREDENTIALS_ID}") {
              docker.image("${IMAGE_NAME}:${TAG}").push()
              docker.image("${IMAGE_NAME}:${TAG}").push("latest")
            }
          }
        }
      }
    }

    stage('‚úèÔ∏è Update K8s Deployment File') {
      steps {
        script {
          def deploymentFile = "${WORKSPACE}/config/${CONFIG_REPO_PATH}"

          sh """
            echo 'üìÅ Current deployment file:'
            cat ${deploymentFile}

            echo '‚úèÔ∏è Updating image tag to: ${TAG}'
            sed -i 's|image: ${IMAGE_NAME}:.*|image: ${IMAGE_NAME}:${TAG}|' ${deploymentFile}

            echo 'üìÅ Updated deployment file:'
            cat ${deploymentFile}
          """
        }
      }
    }
  }

  post {
    success {
      echo "‚úÖ Backend pipeline succeeded. Image pushed and deployment.yaml updated."
    }
    failure {
      echo "‚ùå Pipeline failed."
    }
    aborted {
      echo "üõë Pipeline aborted (no backend changes)."
    }
  }
}
